{"version":3,"sources":["transport/xhr.js"],"names":["global","XMLHttpRequest","definition","Pledge","isObject","base","Url","functionMerge","functionDescriptorGenerate","functionUniqueUuid","serialize","parameter","key","result","encodeURIComponent","replace","regexMatchSpaces","regexMatchOpeningBrackets","regexMatchClosingBrackets","request","method","timeout","self","this","properties","storage","uuid","settings","url","data","xhr","local","XHR","XDR","deferred","defer","searchParams","set","cache","Date","xhrOptions","onprogress","ontimeout","onerror","onabort","reject","onload","clearTimeout","status","resolve","responseText","open","href","setRequestHeader","accept","contentType","header","send","setTimeout","readyState","abort","pledge","TransportXhr","objectDefineProperty","prototype","Object","defineProperty","XDomainRequest","get","call","post","put","delete","head","extend","async","username","password","provide"],"mappings":"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","file":"transport/xhr.js","sourcesContent":["/**\n * Qoopido transport/xhr\n *\n * Provides basic XHR (AJAX) functionality\n *\n * Copyright (c) 2015 Dirk Lueth\n *\n * Dual licensed under the MIT and GPL licenses.\n *  - http://www.opensource.org/licenses/mit-license.php\n *  - http://www.gnu.org/copyleft/gpl.html\n *\n * @author Dirk Lueth <info@qoopido.com>\n *\n * @use /demand/pledge\n * @use /demand/validator/isObject\n *\n * @require ../base\n * @require ../url\n * @require ../function/merge\n * @require ../function/descriptor/generate\n */\n\n(function(global, XMLHttpRequest) {\n\t'use strict';\n\n\tfunction definition(Pledge, isObject, base, Url, functionMerge, functionDescriptorGenerate, functionUniqueUuid) {\n\t\tvar objectDefineProperty      = Object.defineProperty,\n\t\t\tXHR                       = XMLHttpRequest,\n\t\t\tXDR                       = 'XDomainRequest' in global &&  global.XDomainRequest || XHR,\n\t\t\tregexMatchSpaces          = /%20/g,\n\t\t\tregexMatchOpeningBrackets = /%5B/g,\n\t\t\tregexMatchClosingBrackets = /%5D/g,\n\t\t\tstorage                   = {},\n\t\t\tprototype;\n\n\t\tfunction serialize(parameter) {\n\t\t\tvar result = '',\n\t\t\t\tkey;\n\n\t\t\tfor(key in parameter) {\n\t\t\t\tresult += (!result ? '' : '&') + encodeURIComponent(key) + '=' + encodeURIComponent(parameter[key]);\n\t\t\t}\n\n\t\t\treturn result\n\t\t\t\t.replace(regexMatchSpaces, '+')\n\t\t\t\t.replace(regexMatchOpeningBrackets, '[')\n\t\t\t\t.replace(regexMatchClosingBrackets, ']');\n\t\t}\n\n\t\tfunction request(method) {\n\t\t\tvar self       = this,\n\t\t\t\tproperties = storage[self.uuid],\n\t\t\t\tsettings   = properties.settings,\n\t\t\t\turl        = properties.url,\n\t\t\t\tdata       = properties.data,\n\t\t\t\txhr        = url.local ? new XHR() : new XDR(),\n\t\t\t\tdeferred   = Pledge.defer(),\n\t\t\t\tkey, timeout;\n\n\t\t\tif(data && method === 'GET') {\n\t\t\t\tfor(key in data) {\n\t\t\t\t\turl.searchParams.set(key, data[key]);\n\t\t\t\t}\n\n\t\t\t\tdata = null;\n\t\t\t}\n\n\t\t\tif(!settings.cache) {\n\t\t\t\turl.searchParams.set('nucleus[time]', +new Date());\n\t\t\t}\n\n\t\t\tif(data) {\n\t\t\t\tdata = serialize(data);\n\t\t\t}\n\n\t\t\tif(isObject(settings.xhrOptions)) {\n\t\t\t\tfor(key in settings.xhrOptions) {\n\t\t\t\t\txhr[key] = settings.xhrOptions[key];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\txhr.onprogress = function() {};\n\t\t\txhr.ontimeout  = xhr.onerror = xhr.onabort = function() { deferred.reject(); };\n\t\t\txhr.onload     = function() {\n\t\t\t\ttimeout = clearTimeout(timeout);\n\n\t\t\t\tif(!('status' in xhr) || xhr.status === 200) {\n\t\t\t\t\tdeferred.resolve(xhr.responseText);\n\t\t\t\t} else {\n\t\t\t\t\tdeferred.reject();\n\t\t\t\t}\n\t\t\t};\n\n\t\t\txhr.open(method, url.href, true);\n\n\t\t\tif(xhr.setRequestHeader) {\n\t\t\t\txhr.setRequestHeader('Accept', settings.accept);\n\n\t\t\t\tif(data && method !== 'GET') {\n\t\t\t\t\txhr.setRequestHeader('Content-Type', settings.contentType);\n\t\t\t\t}\n\n\t\t\t\tif(isObject(settings.header)) {\n\t\t\t\t\tfor(key in settings.header) {\n\t\t\t\t\t\txhr.setRequestHeader(key, settings.header[key]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\txhr.send(data);\n\n\t\t\ttimeout = setTimeout(function() {\n\t\t\t\tif(xhr.readyState < 4) {\n\t\t\t\t\txhr.abort();\n\t\t\t\t}\n\t\t\t}, settings.timeout);\n\n\t\t\treturn deferred.pledge;\n\t\t}\n\n\t\tfunction TransportXhr(url, data, settings) {\n\t\t\tvar self = this,\n\t\t\t\tuuid = functionUniqueUuid();\n\n\t\t\tobjectDefineProperty(self, 'uuid', functionDescriptorGenerate(uuid));\n\n\t\t\tstorage[uuid] = {\n\t\t\t\tsettings: functionMerge({}, prototype.settings, settings),\n\t\t\t\turl:      new Url(url),\n\t\t\t\tdata:     data\n\t\t\t};\n\t\t}\n\n\t\tTransportXhr.prototype = {\n\t\t\t/* only for reference\n\t\t\tuuid: null,\n\t\t\t*/\n\t\t\tget:      function() {\n\t\t\t\treturn request.call(this, 'GET');\n\t\t\t},\n\t\t\tpost:     function() {\n\t\t\t\treturn request.call(this, 'POST');\n\t\t\t},\n\t\t\tput:      function() {\n\t\t\t\treturn request.call(this, 'PUT');\n\t\t\t},\n\t\t\t'delete': function() {\n\t\t\t\treturn request.call(this, 'DELETE');\n\t\t\t},\n\t\t\thead:     function() {\n\t\t\t\treturn request.call(this, 'HEAD');\n\t\t\t}\n\t\t};\n\n\t\tprototype          = base.extend(TransportXhr);\n\t\tprototype.settings = {\n\t\t\taccept:      '*/*',\n\t\t\ttimeout:     8000,\n\t\t\tasync:       true,\n\t\t\tcache:       false,\n\t\t\tusername:    null,\n\t\t\tpassword:    null,\n\t\t\tcontentType: 'application/x-www-form-urlencoded; charset=UTF-8',\n\t\t\theader:      {},\n\t\t\txhrOptions:  {}\n\t\t};\n\n\t\treturn prototype;\n\t}\n\n\tprovide([ '/demand/pledge', '/demand/validator/isObject', '../base', '../url', '../function/merge', '../function/descriptor/generate', '../function/unique/uuid' ], definition);\n}(this, XMLHttpRequest));"],"sourceRoot":"/source/"}